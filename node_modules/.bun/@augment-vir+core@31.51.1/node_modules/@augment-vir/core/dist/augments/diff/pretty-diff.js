import { diffLines, diffWords } from 'diff';
import { sortObject } from '../object/object-sort.js';
import { stringify } from '../object/stringify.js';
import { isRuntimeEnv, RuntimeEnv } from '../runtime-env.js';
/**
 * Makes a pretty diff output.
 *
 * @category Internal
 * @category Package : @augment-vir/common
 * @package [`@augment-vir/common`](https://www.npmjs.com/package/@augment-vir/common)
 */
export function prettyDiff(actual, expected) {
    const bothStrings = typeof expected === 'string' && typeof actual === 'string';
    const useLines = typeof expected !== 'string' || typeof actual !== 'string';
    const diffFunction = (useLines ? diffLines : diffWords);
    const expectedString = [
        bothStrings ? '' : '\n',
        stringify(!!expected && typeof expected === 'object' && !Array.isArray(expected)
            ? sortObject(expected)
            : expected, 4),
        '\n',
    ].join('');
    const actualString = [
        bothStrings ? '' : '\n',
        stringify(!!actual && typeof actual === 'object' && !Array.isArray(actual)
            ? sortObject(actual)
            : actual, 4),
        '\n',
    ].join('');
    const changes = addDiffColors(useLines, diffFunction(expectedString, actualString));
    const useColor = isRuntimeEnv(RuntimeEnv.Node);
    /* node:coverage ignore next 7: currently only tested in node */
    const explanationLine = [
        useColor ? NodeColor.Green : '',
        ' +added (unexpected, added in actual)',
        useColor ? NodeColor.Red : '',
        ' -missing (expected, missing from actual)',
        useColor ? NodeColor.Reset : '',
    ].join('');
    return [
        explanationLine,
        bothStrings ? '\n\n' : '\n',
        changes,
    ].join('');
}
var NodeColor;
(function (NodeColor) {
    NodeColor["Green"] = "\u001B[32m";
    NodeColor["Red"] = "\u001B[31m";
    NodeColor["Reset"] = "\u001B[0m";
})(NodeColor || (NodeColor = {}));
var DiffPrefix;
(function (DiffPrefix) {
    DiffPrefix["Added"] = "+";
    DiffPrefix["Removed"] = "-";
})(DiffPrefix || (DiffPrefix = {}));
function addDiffColors(shouldUseLines, changes) {
    const coloredDiff = shouldUseLines
        ? changes
            .flatMap((change) => {
            return change.value
                .split('\n')
                .map((line) => {
                return addColorToChange(line, change);
            })
                .join('\n');
        })
            .join('')
        : changes
            .map((change) => {
            return addColorToChange(undefined, change);
        })
            .join('');
    return coloredDiff;
}
function addColorToChange(line, change) {
    if (line != undefined && !line) {
        return '';
    }
    const useColor = isRuntimeEnv(RuntimeEnv.Node);
    const prefix = change.added
        ? DiffPrefix.Added
        : change.removed
            ? DiffPrefix.Removed
            : line == undefined
                ? ''
                : ' ';
    const color = change.added ? NodeColor.Green : change.removed ? NodeColor.Red : NodeColor.Reset;
    return [
        /* node:coverage ignore next 1 */
        useColor ? color : '',
        prefix,
        line ?? change.value,
        NodeColor.Reset,
    ].join('');
}
