"use strict";
Object.defineProperty(exports, Symbol.toStringTag, { value: "Module" });
const server = require("@qwik.dev/core/server");
const requestHandler = require("@qwik.dev/router/middleware/request-handler");
const setCookieParser = require("set-cookie-parser");
function createQwikRouter(opts) {
  if (opts.qwikCityPlan && !opts.qwikRouterConfig) {
    console.warn("qwikCityPlan is deprecated. Simply remove it.");
    opts.qwikRouterConfig = opts.qwikCityPlan;
  }
  if (opts.manifest) {
    server.setServerPlatform(opts.manifest);
  }
  async function onAzureSwaRequest(context, req) {
    try {
      const url = new URL(req.headers["x-ms-original-url"]);
      const options = {
        method: req.method || "GET",
        headers: req.headers,
        body: req.bufferBody || req.rawBody || req.body
      };
      const serverRequestEv = {
        mode: "server",
        locale: void 0,
        url,
        platform: context,
        env: {
          get(key) {
            return process.env[key];
          }
        },
        request: new Request(url, options),
        getWritableStream: (status, headers, cookies, resolve) => {
          const response = {
            status,
            body: new Uint8Array(),
            headers: {},
            cookies: cookies.headers().map((header) => setCookieParser.parseString(header))
          };
          headers.forEach((value, key) => response.headers[key] = value);
          return new WritableStream({
            write(chunk) {
              if (response.body instanceof Uint8Array) {
                const newBuffer = new Uint8Array(response.body.length + chunk.length);
                newBuffer.set(response.body);
                newBuffer.set(chunk, response.body.length);
                response.body = newBuffer;
              }
            },
            close() {
              resolve(response);
            }
          });
        },
        getClientConn: () => {
          return {
            ip: req.headers["x-forwarded-client-Ip"],
            country: void 0
          };
        }
      };
      const handledResponse = await requestHandler.requestHandler(serverRequestEv, opts);
      if (handledResponse) {
        handledResponse.completion.then((err) => {
          if (err) {
            console.error(err);
          }
        });
        const response = await handledResponse.response;
        if (response) {
          return response;
        }
      }
      const notFoundHtml = !req.headers.accept?.includes("text/html") || requestHandler.isStaticPath(req.method || "GET", url) ? "Not Found" : requestHandler.getNotFound(url.pathname);
      return {
        status: 404,
        headers: { "Content-Type": "text/html; charset=utf-8", "X-Not-Found": url.pathname },
        body: notFoundHtml
      };
    } catch (e) {
      console.error(e);
      return {
        status: 500,
        headers: { "Content-Type": "text/plain; charset=utf-8" }
      };
    }
  }
  return onAzureSwaRequest;
}
const createQwikCity = createQwikRouter;
exports.createQwikCity = createQwikCity;
exports.createQwikRouter = createQwikRouter;
